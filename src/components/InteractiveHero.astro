---
import { getCollection } from 'astro:content';

// 1. Obtenemos todos los posts
const allPosts = await getCollection('blog');

// 2. Filtramos para asegurarnos de que tengan los datos necesarios y tomamos 4
const featuredPosts = allPosts
  .filter(post => post.data.title && post.data.description && post.slug)
  .filter(post => post.slug !== 'creando-blog-con-astro') // Excluir el post del viaje de crear un blog
  .filter(post => post.slug !== 'hello-world') // Excluir la sección bienvenida
  .filter(post => post.slug !== 'primer-post') // Excluir la sección mi primer post
  .slice(0, 4); 
---

<div id="webgl-container" class="fixed top-0 left-0 w-full h-full z-0">
  <canvas id="canvas"></canvas>
</div>

<div id="scroll-container" class="relative z-10">
  <div class="background-noise"></div>
  
  <div id="transition-container" class="relative h-[300vh] snap-start">
    <div class="sticky top-0 h-screen w-full overflow-hidden">
      <div class="w-full">
        <!-- Intro Section (fades out) -->
        <section id="intro" class="absolute inset-0 flex flex-col items-center justify-center text-white text-center px-4 animated-gradient">
          <h1 class="text-6xl md:text-8xl font-extrabold tracking-tight mb-4 opacity-0 animate-fade-in-up" style="animation-delay: 0.2s;">PuntoZero</h1>
          <p class="text-lg md:text-xl font-medium tracking-wide opacity-0 animate-fade-in-up animate-fadePulse" style="animation-delay: 0.7s;">Desliza para empezar el viaje</p>
          <div class="absolute bottom-10 left-1/2 -translate-x-1/2 text-white animate-bounce opacity-0 animate-fade-in-up" style="animation-delay: 1.2s;" aria-label="Desliza hacia abajo">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
          </div>
        </section>

        <!-- Welcome Section (fades in and out) -->
        <section id="bienvenida" class="block min-h-screen w-full flex flex-col items-center justify-start text-white px-4 text-center py-16 bg-gradient-to-b from-black to-gray-900">
          <div class="max-w-2xl w-full px-4">
            <h1 class="text-4xl md:text-6xl font-extrabold tracking-tight leading-tight mb-[10px] text-soft-shadow">Bienvenid@</h1>
            <p class="text-base md:text-xl leading-relaxed max-w-2xl mx-auto text-soft-shadow mb-1">
              "Puede decirse que el grito de la historia nace con nosotros y que es uno de nuestros dones más importantes. En cierto sentido somos históricos todos los [Humanos]".
            </p>
            <p class="block text-sm md:text-base mt-1 mb-1">Thomas Carlyle (1795-1881)</p>

            <p class="text-base md:text-xl leading-relaxed max-w-2xl mx-auto text-soft-shadow mb-[10px]">
              Cada uno de nosotros contamos con memorias profundas, e indudablemente, tienen un valor inigualable en el transitar de esta historia que tejemos en colectivo, y en este viaje llamado vida, cada individuo lleva consigo experiencias fortalecedoras, que en el compartir, edifican las bases para aquellos procesos que suelen ser complejos y densos de caminar en otredad.
            </p>

            <p class="text-base md:text-xl leading-relaxed max-w-2xl mx-auto text-soft-shadow mb-5">
              Este escenario se convierte entonces, en una invitación desde el respeto, para que compartas entre líneas, aquellas historias que te han construido y han recreado el Ser que te habita. Cuentas con total libertad para danzar entre letras, crear narraciones fantásticas, apasionadas y vibrantes.
            </p>

            <p class="text-base md:text-xl leading-relaxed max-w-2xl mx-auto text-soft-shadow mb-5">
              Recuerda expandir tu esencia y tu poder creador, ¡Tu voz interior tiene mucho que leer, escuchar y contar!
            </p>

            <p class="text-base md:text-xl leading-relaxed max-w-2xl mx-auto text-soft-shadow mt-[10px] font-semibold">
              Con gran emoción ¡Gracias y más gracias!
              <br><span class="block font-normal mt-2">- Gina Magali</span>
            </p>
          </div>
          <div id="welcome-scroll-arrow" class="absolute bottom-10 left-1/2 -translate-x-1/2 text-white animate-bounce cursor-pointer" aria-label="Desliza hacia abajo">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
          </div>
        </section>
        
        <!-- Station 1 (fades in) -->
        <section id="estacion-1" class="absolute inset-0 flex items-center justify-center text-white opacity-0 px-4 text-center bg-gradient-to-b from-black to-gray-900">
          <div class="text-center max-w-xl">
            <h2 class="text-4xl md:text-5xl font-semibold mb-6">PuntoZero</h2>
            <p class="text-lg md:text-xl leading-relaxed text-gray-300 max-w-xl mx-auto">
              Este es un espacio para compartir historias reales, encuentros con lo esencial y viajes personales. 
              PuntoZero es el inicio de un recorrido hacia lo profundo: luz y oscuridad, inicios y finales, 
              pero sobre todo, lo que nunca termina: tu propia historia.
            </p>
            <p class="text-lg md:text-xl leading-relaxed text-gray-300 max-w-xl mx-auto mt-4">
              Este es el sótano de mis recuerdos, pensamientos, miedos, sueños y tristezas, aquí hay un poco de esa oscuridad y de esa luz de la que tú también tienes. Aquí quiero compartir un poco de lo que soy. Tal vez seamos muy parecidos o muy diferentes, eso lo descubriremos entre estas líneas.
            </p>
          </div>
          <div id="estacion1-scroll-arrow" class="absolute bottom-6 left-1/2 -translate-x-1/2 text-white animate-bounce cursor-pointer" aria-label="Desliza hacia abajo">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
          </div>
        </section>
      </div>
    </div>
  </div>

  <section id="card-station" class="h-screen snap-start flex flex-col items-center justify-center bg-black text-white px-4">
    <div class="text-center text-white text-xl md:text-2xl leading-relaxed mb-8 px-4">
      <p>Aquí puedes navegar entre lo que tengo por contarte.</p>
      <p>Gran parte de lo que soy está aquí.</p>
      <p>Tal cual.</p>
    </div>
    <div class="max-w-6xl mx-auto grid grid-cols-2 md:grid-cols-4 gap-4 px-4">
      <a href="/notas-diarias" class="block">
        <div class="flex items-center justify-center bg-gradient-to-b from-gray-800 to-gray-900 border border-gray-700 rounded-2xl shadow-md text-white text-lg md:text-xl font-semibold p-4 m-2 text-center hover:bg-gamma-700 hover:scale-105 transition-transform duration-300 ease-in-out">Diaria<br />Mente</div>
      </a>
      <a href="/gina-castillo" class="block">
        <div class="flex items-center justify-center bg-gradient-to-b from-gray-800 to-gray-900 border border-gray-700 rounded-2xl shadow-md text-white text-lg md:text-xl font-semibold p-4 m-2 text-center hover:bg-gamma-700 hover:scale-105 transition-transform duration-300 ease-in-out">Gina<br />Castillo</div>
      </a>
      <a href="/pasos-historias" class="block">
        <div class="flex items-center justify-center bg-gradient-to-b from-gray-800 to-gray-900 border border-gray-700 rounded-2xl shadow-md text-white text-lg md:text-xl font-semibold p-4 m-2 text-center hover:bg-gamma-700 hover:scale-105 transition-transform duration-300 ease-in-out">Pasos e historias</div>
      </a>
      <a href="/diario-malos" class="block">
        <div class="flex items-center justify-center bg-gradient-to-b from-gray-800 to-gray-900 border border-gray-700 rounded-2xl shadow-md text-white text-lg md:text-xl font-semibold p-4 m-2 text-center hover:bg-gray-700 hover:scale-105 transition-transform duration-300 ease-in-out">El diario de los malos</div>
      </a>
      <a href="/vicios-placeres" class="block">
        <div class="flex items-center justify-center bg-gradient-to-b from-gray-800 to-gray-900 border border-gray-700 rounded-2xl shadow-md text-white text-lg md:text-xl font-semibold p-4 m-2 text-center hover:bg-gray-700 hover:scale-105 transition-transform duration-300 ease-in-out">Padre y Madre</div>
      </a>
      <a href="/historias-diarias" class="block">
        <div class="flex items-center justify-center bg-gradient-to-b from-gray-800 to-gray-900 border border-gray-700 rounded-2xl shadow-md text-white text-lg md:text-xl font-semibold p-4 m-2 text-center hover:bg-gray-700 hover:scale-105 transition-transform duration-300 ease-in-out">Nuestras voces</div>
      </a>
      <a href="/neurodivergencias" class="block">
        <div class="flex items-center justify-center bg-gradient-to-b from-gray-800 to-gray-900 border border-gray-700 rounded-2xl shadow-md text-white text-lg md:text-xl font-semibold p-4 m-2 text-center hover:bg-gray-700 hover:scale-105 transition-transform duration-300 ease-in-out">Neuro<br />divergencias</div>
      </a>
      <a href="/vicios-placeres-2" class="block">
        <div class="flex items-center justify-center bg-gradient-to-b from-gray-800 to-gray-900 border border-gray-700 rounded-2xl shadow-md text-white text-lg md:text-xl font-semibold p-4 m-2 text-center hover:bg-gray-700 hover:scale-105 transition-transform duration-300 ease-in-out">Vicios y placeres</div>
      </a>
    </div>
  </section>

  {featuredPosts.map((post, index) => (
    <section class="h-screen snap-start flex items-center justify-center bg-black text-white px-4">
      <div class="text-center max-w-2xl">
        <h2 class="text-3xl md:text-5xl font-bold tracking-wide">{post.data.title}</h2>
        <p class="mt-4 text-lg md:text-xl opacity-80">{post.data.description}</p>
        <a href={`/blog/${post.slug}`} class="mt-8 inline-block bg-white text-black font-bold py-3 px-8 rounded-lg hover:bg-gray-200 transition-colors">
          Leer más
        </a>
      </div>
    </section>
  ))}
  
  <section class="h-screen snap-start flex items-center justify-center text-center text-white bg-black">
    <h2 class="text-4xl md:text-6xl font-bold">Gracias por tu visita</h2>
  </section>
</div>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    const intro = document.getElementById('intro');
    const bienvenida = document.getElementById('bienvenida');
    const estacion1 = document.getElementById('estacion-1');
    const transitionContainer = document.getElementById('transition-container');

    if (!intro || !bienvenida || !estacion1 || !transitionContainer) {
      console.error("InteractiveHero sections not found, animations disabled.");
      return;
    }

    const resetInteractiveHeroState = () => {
      intro.style.opacity = '1';
      intro.style.pointerEvents = 'auto';
      bienvenida.style.opacity = '0';
      bienvenida.style.pointerEvents = 'none';
      estacion1.style.opacity = '0';
      estacion1.style.pointerEvents = 'none';
    };

    const handleScroll = () => {
      const { top, bottom, height } = transitionContainer.getBoundingClientRect();

      // Solo ejecutar la animación cuando el contenedor de transición está en la pantalla.
      // Esto evita conflictos con el scroll-snap de las secciones posteriores.
      if (bottom < 0 || top > window.innerHeight) {
        return;
      }

      const scrollableDistance = height - window.innerHeight;
      const progress = Math.max(0, Math.min(1, -top / scrollableDistance));

      // Fase 1: Intro -> Bienvenida (progreso de 0.0 a 0.5)
      const introOpacity = Math.max(0, 1 - progress / 0.5);
      // Fase 2: Bienvenida -> Estacion-1 (progreso de 0.5 a 1.0)
      const estacion1Opacity = Math.max(0, (progress - 0.5) / 0.5);
      // La sección de bienvenida es visible en ambas fases, creando un fundido de entrada y salida.
      const bienvenidaOpacity = Math.max(0, 1 - introOpacity - estacion1Opacity);

      intro.style.opacity = introOpacity.toString();
      bienvenida.style.opacity = bienvenidaOpacity.toString();
      estacion1.style.opacity = estacion1Opacity.toString();

      // Gestionar eventos de puntero para evitar clics en secciones invisibles.
      intro.style.pointerEvents = introOpacity > 0.1 ? 'auto' : 'none';
      bienvenida.style.pointerEvents = bienvenidaOpacity > 0.1 ? 'auto' : 'none';
      estacion1.style.pointerEvents = estacion1Opacity > 0.1 ? 'auto' : 'none';
    };
    
    // Resetear estado al cargar la página
    resetInteractiveHeroState();
    window.scrollTo(0, 0);

    // Escuchar el evento de scroll con la opción passive para mejor rendimiento.
    window.addEventListener('scroll', handleScroll, { passive: true });

    // Usar 'pageshow' para resetear el estado al navegar hacia atrás.
    // Es más fiable que otros métodos para la cache de los navegadores.
    window.addEventListener('pageshow', (event) => {
      if (event.persisted) {
        resetInteractiveHeroState();
        window.scrollTo(0, 0);
      }
    });
  });
</script>

<script src="../scripts/interactive-hero.js"></script> 

<style>
  #intro {
    background: linear-gradient(to bottom, rgba(0,0,0,0.7) 0%, rgba(30,30,30,0.7) 60%, rgba(20,20,20,0.95) 100%), url('/backgrounds/fondoblog4.jpg') center center / cover no-repeat;
    background-repeat: no-repeat;
    background-size: cover;
    background-position: center 60%;
    min-height: 100vh;
    width: 100%;
  }

  #bienvenida, #estacion-1 {
    background: linear-gradient(to bottom, #000000, #0a0a0a, #1a1a1a);
    background-size: 100% 200%;
    background-position: center 60%;
  }

  #estacion-1 {
    background: linear-gradient(to bottom, rgba(0,0,0,0.85) 0%, rgba(30,30,30,0.7) 60%, rgba(20,20,20,0.95) 100%), url('/backgrounds/fondoblog2.jpg') center center / cover no-repeat;
    background-attachment: scroll;
    background-size: cover;
    background-position: center 60%;
  }

  #bienvenida {
    background: linear-gradient(to bottom, rgba(0,0,0,0.7) 0%, rgba(30,30,30,0.7) 60%, rgba(20,20,20,0.95) 100%), url('/backgrounds/fondoblog5.jpg') center center / cover no-repeat;
    background-repeat: no-repeat;
    background-size: cover;
    background-position: center 60%;
    min-height: 100vh;
    width: 100%;
  }

  @keyframes grainMovement {
    0%, 100% {
      transform: translate(0, 0);
    }
    50% {
      transform: translate(1px, -1px);
    }
  }

  #card-station {
    background: linear-gradient(to bottom, rgba(0,0,0,0.7) 0%, rgba(30,30,30,0.7) 60%, rgba(20,20,20,0.95) 100%), url('/backgrounds/fondoblog3.jpg') center center / cover no-repeat;
    background-attachment: scroll;
    background-size: cover;
    background-position: center 60%;
    min-height: 100vh;
    width: 100%;
  }
</style>